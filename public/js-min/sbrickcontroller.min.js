var SBrickChannel=Backbone.Model.extend({idAttribute:"channelId",defaults:{channelId:null,min:-255,max:255,keyInc:null,keyDec:null},initialize:function(){},getKeyNames:function(){return{keyIncName:keycode(this.get("keyInc")),keyDecName:keycode(this.get("keyDec"))}}}),SBrickChannelCollection=Backbone.Collection.extend({model:SBrickChannel}),SBrick=Backbone.Model.extend({idAttribute:"uuid",defaults:{uuid:null,swVersion:null,hwVersion:null,secured:!1,connected:!1,password:null,streamUrl:null},initialize:function(){this.listenTo(this.channels,"change",function(){this.save()}),this.voltages=new TimeSeries,this.temperatures=new TimeSeries,this.set("connected",!1)},toJSON:function(e){return{uuid:this.get("uuid"),password:this.get("password"),streamUrl:this.get("streamUrl"),channels:this.channels.toJSON(e)}},parse:function(e,t){return void 0===this.channels&&(this.channels=new SBrickChannelCollection,this.channels.add(new SBrickChannel({channelId:0})),this.channels.add(new SBrickChannel({channelId:1})),this.channels.add(new SBrickChannel({channelId:2})),this.channels.add(new SBrickChannel({channelId:3}))),e.channels&&this.channels.reset(e.channels),_.omit(e,"channels")},addVoltage:function(e,t){this.voltages.append(e,t)},addTemperature:function(e,t){this.temperatures.append(e,t)},connect:function(){this.get("connected")||this.trigger("connect",this)},disconnect:function(){this.get("connected")&&this.trigger("disconnect",this)},setConnected:function(e){this.set("connected",e),!1===e&&(this.voltages.clear(),this.temperatures.clear())},getProxiedStreamUrl:function(){return"/sbricks/"+this.get("uuid")+"/video?rnd="+Math.random()}}),SBrickCollection=Backbone.Collection.extend({model:SBrick,url:"/sbricks"}),SBrickChannelView=Backbone.View.extend({template:_.template($("#sbrick-channel-view").text()),events:{"change input[type=number]":"updateModel","keydown input[type=text]":"setKey"},initialize:function(){},render:function(){return this.setElement(this.template(_.merge(this.model.attributes,this.model.getKeyNames()))),this},setKey:function(e){e.preventDefault();var t=$(e.target).hasClass("sbrick-control-panel-channel-keyinc")?"keyInc":"keyDec";this.model.set(t,e.which),$(e.target).val(keycode(e.which)).blur()},updateModel:function(){this.model.set({min:parseInt(this.$(".sbrick-control-panel-channel-minvalue").val(),10),max:parseInt(this.$(".sbrick-control-panel-channel-maxvalue").val(),10)})},destroy:function(){this.remove()}}),SBrickView=Backbone.View.extend({template:_.template($("#sbrick-view").text()),events:{"blur .sbrick-control-panel-password":"updateModel","blur .sbrick-control-panel-stream-url":"updateModel","click .sbrick-control-panel-connect":"connect","click .sbrick-control-panel-disconnect":"disconnect"},initialize:function(){this.channelViews=[],this.timeline=null,this.listenTo(this.model,"change:connected",this.initChart),this.listenTo(this.model,"change:connected",this.setButtons),this.listenTo(this.model,"change:streamUrl",this.setStream)},render:function(){this.setElement(this.template(this.model.attributes));var n=this;return this.model.channels.forEach(function(e){var t=new SBrickChannelView({model:e});t.render().$el.appendTo(n.$(".sbrick-control-panel-channels")),n.channelViews.push(t)}),!1===this.model.get("secured")&&this.$(".sbrick-control-panel-passwords").hide(),this.setButtons(),this.setStream(),this},initChart:function(){null===this.timeline?(this.resizeCanvas(),this.timeline=new SmoothieChart({minValue:0,millisPerPixel:25}),this.timeline.addTimeSeries(this.model.voltages,{strokeStyle:"rgba(0, 255, 0, 1)",fillStyle:"rgba(0, 255, 0, 0.2)",lineWidth:1}),this.timeline.addTimeSeries(this.model.temperatures,{strokeStyle:"rgba(255, 0, 0, 1)",fillStyle:"rgba(255, 0, 0, 0.2)",lineWidth:1}),this.timeline.streamTo(this.$(".sbrick-control-panel-chart")[0])):this.model.get("connected")?this.timeline.start():this.timeline.stop()},setButtons:function(){this.model.get("connected")?(this.$(".sbrick-control-panel-connect").addClass("pure-button-disabled"),this.$(".sbrick-control-panel-disconnect").removeClass("pure-button-disabled")):(this.$(".sbrick-control-panel-connect").removeClass("pure-button-disabled"),this.$(".sbrick-control-panel-disconnect").addClass("pure-button-disabled"))},setStream:function(){this.model.get("streamUrl")?this.$(".sbrick-control-panel-stream").attr("src",this.model.getProxiedStreamUrl()).show():this.$(".sbrick-control-panel-stream").hide()},resizeCanvas:function(){this.$(".sbrick-control-panel-chart")[0].width=this.$el.width()},updateModel:function(){this.model.set("password",this.$(".sbrick-control-panel-password").val()),this.model.set("streamUrl",this.$(".sbrick-control-panel-stream-url").val()),this.model.save()},connect:function(){this.model.connect()},disconnect:function(){this.model.disconnect()},destroy:function(){this.channelViews.forEach(function(e){e.destroy()}),this.remove()}}),SBrickControllerView=Backbone.View.extend({events:{keydown:"keydown",keyup:"keyup","click #sbrick-list-scan":"scan"},initialize:function(){this.views=[],this.model=new SBrickCollection,this.listenTo(this.model,"add",this.addSBrickView),this.listenTo(this.model,"remove",this.removeSBrickView),this.listenTo(this.model,"connect",this.connect),this.listenTo(this.model,"disconnect",this.disconnect)},addSBrickView:function(e){var t=new SBrickView({model:e});t.render().$el.appendTo(this.$("#sbricks")),this.views.push(t)},removeSBrickView:function(s){this.views.reduceRight(function(e,t,n,i){t.model===s&&(t.destroy(),i.splice(n,1))},[])},keydown:function(e){var n=e.which;this.model.where({connected:!0}).forEach(function(t){t.channels.forEach(function(e){e.get("keyDec")===n&&Socket.controlChannel(t.get("uuid"),e.get("channelId"),e.get("min")),e.get("keyInc")===n&&Socket.controlChannel(t.get("uuid"),e.get("channelId"),e.get("max"))})})},keyup:function(e){var n=e.which;this.model.where({connected:!0}).forEach(function(t){t.channels.forEach(function(e){e.get("keyDec")!==n&&e.get("keyInc")!==n||Socket.controlChannel(t.get("uuid"),e.get("channelId"),0)})})},scan:function(){this.model.some({connected:!0})&&!confirm("Warning: this will disconnect everything!")||(this.$("#sbrick-list-scan").attr("disabled","disabled"),Socket.scan())},scanResponse:function(e){this.$("#sbrick-list-scan").removeAttr("disabled"),this.model.set(e,{parse:!0})},error:function(e,t){console.log("error",e,t)},connect:function(e){var t=e.get("uuid");Socket.connect(t,e.get("password"))},connected:function(e){this.model.get(e).setConnected(!0)},disconnect:function(e){var t=e.get("uuid");Socket.disconnect(t)},disconnected:function(e){this.model.get(e).setConnected(!1)},voltage:function(e,t){this.model.get(e).addVoltage(Date.now(),t)},temperature:function(e,t){this.model.get(e).addTemperature(Date.now(),t)},disconnectedFromServer:function(){this.model.set([])}}),Socket={initialize:function(){this.socket=io.connect(document.location.href),this.socket.on("SBrick.scanResponse",this.scanResponse),this.socket.on("SBrick.connected",this.connected),this.socket.on("SBrick.disconnected",this.disconnected),this.socket.on("SBrick.error",this.error),this.socket.on("SBrick.voltAndTemp",this.voltAndTemp),this.socket.on("SBrick.voltage",this.voltage),this.socket.on("SBrick.temperature",this.temperature),this.socket.on("connect",this.scan.bind(this)),this.socket.on("disconnect",this.disconnectedFromServer),this.socket.on("log",this.log)},scan:function(){this.socket.emit("SBrick.scan")},scanResponse:function(e){app.scanResponse(e)},connect:function(e,t){this.socket.emit("SBrick.connect",e,t)},connected:function(e){app.connected(e)},disconnect:function(e){this.socket.emit("SBrick.disconnect",e)},disconnected:function(e){app.disconnected(e)},controlChannel:function(e,t,n){this.socket.emit("SBrick.controlChannel",e,t,n)},error:function(e,t){app.error(e,t)},voltAndTemp:function(e,t,n){app.voltage(e,t),app.temperature(e,n)},voltage:function(e,t){app.voltage(e,t)},temperature:function(e,t){app.temperature(e,t)},disconnectedFromServer:function(){app.disconnectedFromServer()},log:function(e,t){console.log(e,t)}},app=new SBrickControllerView({el:$("body")});Socket.initialize();